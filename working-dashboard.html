<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alec's OLIVER Dashboard</title>
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- React and ReactDOM -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  
  <!-- Recharts and its dependencies -->
  <script src="https://unpkg.com/prop-types/prop-types.min.js"></script>
  <script src="https://unpkg.com/recharts/umd/Recharts.js"></script>
  
  <!-- Babel for JSX -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  
  <!-- Custom CSS -->
  <link rel="stylesheet" href="styles.css">
  
  <style>
    .auth-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(255, 255, 255, 0.95);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .auth-card {
      max-width: 500px;
      padding: 30px;
      background: white;
      border: 2px solid black;
      border-radius: 8px;
      box-shadow: 5px 5px 0 rgba(0,0,0,0.1);
      text-align: center;
    }
    .auth-btn {
      display: inline-block;
      background-color: #4299e1;
      color: white;
      padding: 10px 15px;
      border: 2px solid black;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      margin-top: 20px;
      text-decoration: none;
    }
  </style>
</head>
<body class="p-4">
  <!-- Auth check overlay that will disappear if authenticated -->
  <div id="auth-check" class="auth-overlay">
    <div class="auth-card">
      <h2 class="text-xl font-bold mb-2">Authentication Required</h2>
      <p class="mb-4">You must login to access the dashboard.</p>
      <a href="firebase-auth.html" class="auth-btn">Go to Login</a>
    </div>
  </div>

  <div id="root" class="max-w-7xl mx-auto"></div>

  <script>
    // Check for authentication as soon as the page loads
    document.addEventListener('DOMContentLoaded', function() {
      const authUser = JSON.parse(localStorage.getItem('oliverDashboard_authUser') || '{}');
      const isAuthenticated = authUser && authUser.uid;
      
      if (isAuthenticated) {
        // User is authenticated, hide the overlay
        document.getElementById('auth-check').style.display = 'none';
      } else {
        // User is not authenticated, redirect to login after a brief delay
        setTimeout(() => {
          window.location.href = 'firebase-auth.html';
        }, 1500);
      }
    });
  </script>

  <script type="text/babel">
    // Get auth state from localStorage
    const authUser = JSON.parse(localStorage.getItem('oliverDashboard_authUser') || '{}');
    const isAdmin = authUser.isAdmin || false;
    
    // Handle logout from dashboard
    const handleLogout = () => {
      localStorage.removeItem('oliverDashboard_authUser');
      window.location.href = 'firebase-auth.html';
    };
    
    // Destructure the components we need from Recharts
    const { 
      BarChart, Bar, LineChart, Line, PieChart, Pie, XAxis, YAxis, 
      CartesianGrid, Tooltip, Legend, ResponsiveContainer, Cell 
    } = Recharts;
    
    // Load data from localStorage if available
    const loadFromLocalStorage = (key, defaultValue) => {
      try {
        // For projectCategories, always use the defaults to ensure fixed categories
        if (key === 'projectCategories') {
          return defaultValue;
        }
        
        const savedData = localStorage.getItem(`oliverDashboard_${key}`);
        return savedData ? JSON.parse(savedData) : defaultValue;
      } catch (error) {
        console.error(`Error loading ${key} from localStorage:`, error);
        return defaultValue;
      }
    };

    // Save data to localStorage
    const saveToLocalStorage = (key, data) => {
      try {
        // For projectCategories, skip saving to ensure we always use the defaults
        if (key === 'projectCategories') {
          return;
        }
        localStorage.setItem(`oliverDashboard_${key}`, JSON.stringify(data));
      } catch (error) {
        console.error(`Error saving ${key} to localStorage:`, error);
      }
    };
    
    // Show notification
    const showNotification = (message, type = 'success') => {
      const notification = document.createElement('div');
      
      // Use our external CSS classes
      notification.className = `notification notification-${type}`;
      notification.innerHTML = message;
      document.body.appendChild(notification);
      
      // Remove notification after 3 seconds
      setTimeout(() => {
        notification.remove();
      }, 3000);
    };

    // Main Dashboard Component
    const AgencyDashboard = () => {
      // Default values for all state
      // Function to generate a random vibrant color
      const generateRandomColor = () => {
        // Using HSL to ensure vibrant colors
        const hue = Math.floor(Math.random() * 360);
        return `hsl(${hue}, 80%, 60%)`;
      };
      
      // Clear any "New Project" categories from localStorage
      localStorage.removeItem('oliverDashboard_projectCategories');
      
      const defaultCategories = [
        { id: 1, name: 'Resourced Projects', color: '#0088FE' },
        { id: 2, name: 'Biz Dev', color: '#00C49F' },
        { id: 3, name: 'Consultation/Oversight', color: '#FFBB28' },
        { id: 4, name: 'Team & Admin', color: '#FF8042' },
        { id: 5, name: 'Retainer', color: '#8884d8' }
      ];
      
      const defaultTeamMembers = [
        { 
          name: 'Alec', 
          role: 'Head of Behavioural Science & UX',
          allocations: [
            { project: 'Fairview Homes XD', days: 1, categoryId: 1 },
            { project: 'Semblance (Synthetic Personas)', days: 3, categoryId: 2 },
            { project: 'LifeSkills AI Transformation', days: 1, categoryId: 3 },
            { project: 'Additional work', days: 0.5, categoryId: 4 }
          ],
          totalDays: 5.5,
          capacity: 4,
          utilisation: 138
        },
        { 
          name: 'Aarti', 
          role: 'Lead Experience Planner',
          allocations: [
            { project: 'Barclays LifeSkills', days: 2, categoryId: 5 },
            { project: 'Fairview Homes XD', days: 2, categoryId: 1 }
          ],
          totalDays: 4,
          capacity: 4,
          utilisation: 100
        },
        { 
          name: 'Derek Jellow', 
          role: 'Senior UX Designer',
          allocations: [
            { project: 'BMW Websites', days: 2, categoryId: 1 },
            { project: 'Pinsent Mason', days: 3, categoryId: 5 }
          ],
          totalDays: 5,
          capacity: 5,
          utilisation: 100
        }
      ];
      
      const [activeView, setActiveView] = React.useState('executive');
      const [isEditing, setIsEditing] = React.useState(false);
      const [originalData, setOriginalData] = React.useState(null);
      const [hasUnsavedChanges, setHasUnsavedChanges] = React.useState(false);
      
      // Additional state for pipeline section edit modes
      const [editingPipelineOpportunities, setEditingPipelineOpportunities] = React.useState(false);
      const [editingBusinessDevActivities, setEditingBusinessDevActivities] = React.useState(false);
      const [pipelineOpportunitiesOriginalData, setPipelineOpportunitiesOriginalData] = React.useState(null);
      const [businessDevActivitiesOriginalData, setBusinessDevActivitiesOriginalData] = React.useState(null);
      
      // PROJECT CATEGORIES - load from localStorage or use defaults
      const [projectCategories, setProjectCategories] = React.useState(() => 
        loadFromLocalStorage('projectCategories', defaultCategories)
      );
      
      // TEAM DATA - load from localStorage or use defaults
      const [teamMembers, setTeamMembers] = React.useState(() => 
        loadFromLocalStorage('teamMembers', defaultTeamMembers)
      );
      
      // CURRENT PROJECTS - load from localStorage or use defaults
      const defaultProjects = [
        { 
          id: 1, 
          name: 'Fairview Homes',
          startDate: '2025-04-01',
          endDate: '2025-07-31',
          timeframe: 'April to July', // Keeping for backward compatibility
          value: 20000, 
          status: 'Confirmed',
          team: ['Alec', 'Aarti']
        },
        { 
          id: 2, 
          name: 'E.ON AI Transformation',
          startDate: '2025-05-01',
          endDate: '2025-05-31',
          timeframe: 'May onwards', // Keeping for backward compatibility
          value: 40000, 
          status: 'Pending',
          notes: 'Value TBC',
          team: ['Alec']
        },
        { 
          id: 3, 
          name: 'Barclays BeSci Arrow (Amazon Card)',
          startDate: '2025-04-01',
          endDate: '2025-06-30',
          timeframe: 'April to June', // Keeping for backward compatibility
          value: 30000, 
          status: 'Confirmed',
          team: ['Alec']
        },
        { 
          id: 4, 
          name: 'Crest XD Pitch',
          startDate: '2025-05-01',
          endDate: '2025-06-30',
          timeframe: 'May to June', // Keeping for backward compatibility
          value: 50000, 
          status: 'Pitch',
          notes: 'Cross-functional with Adam',
          team: ['Alec']
        },
        { 
          id: 5, 
          name: 'CPHI Informa Chatbot',
          startDate: '2025-05-01',
          endDate: '2025-05-31',
          timeframe: 'May onwards', // Keeping for backward compatibility
          value: 40000, 
          status: 'Pitch',
          notes: 'Sales pitch £30-50k',
          team: ['Alec']
        },
        { 
          id: 6, 
          name: 'Slipstream HCD Project',
          startDate: '2025-05-01',
          endDate: '2025-05-31',
          timeframe: '2 months work, unallocated', // Keeping for backward compatibility
          value: 35000, 
          status: 'Pending',
          team: ['Alec']
        },
        { 
          id: 7, 
          name: 'Ford BPQ',
          startDate: '2025-05-01',
          endDate: '2025-05-31',
          timeframe: '4 weeks left + 12 month contract', // Keeping for backward compatibility
          value: 15000, 
          status: 'Ongoing',
          notes: 'Support 0.5 days a week, needs freelancer',
          team: ['Alec']
        },
        { 
          id: 8, 
          name: 'Semblance Synthetic Personas Tool',
          startDate: '2025-05-01',
          endDate: '2025-05-31',
          timeframe: 'Ongoing (3 days every week)', // Keeping for backward compatibility
          value: 20000, 
          status: 'Ongoing',
          notes: 'Min. £20k revenue per usage',
          team: ['Alec']
        }
      ];
      
      const [currentProjects, setCurrentProjects] = React.useState(() => 
        loadFromLocalStorage('currentProjects', defaultProjects)
      );
      
      // Default Semblance opportunities
      const defaultSemblanceOpportunities = [
        { client: 'HSBC', status: 'Prospect', value: 20000 },
        { client: 'HSBC Private Banking', status: 'Prospect', value: 20000 },
        { client: 'HSBC Asset Management', status: 'Prospect', value: 20000 },
        { client: 'Jaguar Land Rover InMotion', status: 'Prospect', value: 20000 },
        { client: 'Clyde & Co', status: 'In Progress', value: 20000, notes: 'Already begun, costing up' },
        { client: 'Microsoft', status: 'Pitch', value: 20000, notes: 'F2F presenting in April-May' },
        { client: 'King Gaming', status: 'Pitch', value: 20000, notes: 'F2F presenting in April-May' },
        { client: 'Informa', status: 'Prospect', value: 20000 },
        { client: 'Tide', status: 'Pitch', value: 20000, notes: 'F2F presenting in April-May' },
        { client: 'Arsenal Football Club', status: 'Pitch', value: 20000, notes: 'Presenting in April' },
        { client: 'Hidden Hearing', status: 'Confirmed', value: 60000, notes: 'Project allocated' },
        { client: 'NBC Universal', status: 'Prospect', value: 20000 },
        { client: 'Secret Escapes', status: 'Prospect', value: 20000 },
        { client: 'Travelex', status: 'Prospect', value: 20000 },
        { client: 'Teya', status: 'Prospect', value: 20000 },
        { client: 'Farfetch', status: 'Prospect', value: 20000 },
        { client: 'BBC Creative', status: 'Prospect', value: 20000 }
      ];
      
      const [semblanceOpportunities, setSemblanceOpportunities] = React.useState(() => 
        loadFromLocalStorage('semblanceOpportunities', defaultSemblanceOpportunities)
      );
      
      // PIPELINE PROJECTS
      const defaultPipelineProjects = [
        { 
          name: 'Kimberley-Clark Website Redesign (North America)', 
          value: 100000, 
          notes: '£100k+', 
          status: 'Pipeline' 
        },
        { 
          name: 'Ford - ongoing', 
          value: 6000000, 
          notes: '£6m account (needs attention from me)', 
          status: 'Active Account' 
        },
        { 
          name: 'BMW Q3 Pitch', 
          value: 200000, 
          notes: 'Estimated value', 
          status: 'Pipeline' 
        }
      ];
      
      const [pipelineProjects, setPipelineProjects] = React.useState(() => 
        loadFromLocalStorage('pipelineProjects', defaultPipelineProjects)
      );
      
      // Default resourcing insights template (content will be updated after calculations)
      const defaultResourcingInsights = [
        {
          id: 1,
          type: 'amber',
          title: 'Opportunity cost',
          content: 'Without additional resourcing, we risk losing potential Semblance revenue (assuming 50% conversion)'
        },
        {
          id: 2,
          type: 'blue',
          title: 'Focus dilution',
          content: 'Large accounts like Ford (£6m) aren\'t receiving sufficient attention due to capacity constraints'
        },
        {
          id: 3,
          type: 'green',
          title: 'ROI calculation',
          content: 'New hire at £55-65k salary would pay for themselves with just 3 additional Semblance clients or 1 major project'
        }
      ];
      
      const [resourcingInsights, setResourcingInsights] = React.useState(() => 
        loadFromLocalStorage('resourcingInsights', defaultResourcingInsights)
      );
      
      // INTERNAL AND SALES SUPPORT ACTIVITIES
      const defaultInternalActivities = [
        { name: 'CMO Inspired', type: 'Keynote', timeframe: 'Q2', timeImpact: 'High' },
        { name: 'The CMO Network', type: 'Keynote', timeframe: 'Q2', timeImpact: 'High' },
        { name: 'Procurement Conference', type: 'Keynote', timeframe: 'Late May', timeImpact: 'High' },
        { name: 'MAD//Fest', type: 'Keynote', timeframe: 'June-July', timeImpact: 'High' },
        { name: 'BeSci of Performance Marketing', type: 'Presentation', timeframe: 'April', notes: 'To Barclays', timeImpact: 'Medium' },
        { name: 'Writing new UX Creds for pitches', type: 'Documentation', timeframe: 'Ongoing', timeImpact: 'Medium' },
        { name: 'Writing and collating case studies', type: 'Documentation', timeframe: 'Ongoing', timeImpact: 'Medium' },
        { name: 'Dealing with resourcing', type: 'Admin', timeframe: 'Ongoing', notes: 'Minimum 0.5 days a week', timeImpact: 'High' }
      ];
      
      const [internalActivities, setInternalActivities] = React.useState(() => 
        loadFromLocalStorage('internalActivities', defaultInternalActivities)
      );
      
      // Add effect hooks to save data to localStorage when it changes
      // Add effect hook to detect unsaved changes when in edit mode
      React.useEffect(() => {
        if (isEditing && originalData) {
          setHasUnsavedChanges(true);
        } else {
          setHasUnsavedChanges(false);
        }
      }, [isEditing, originalData, teamMembers, currentProjects, pipelineProjects, internalActivities]);
      
      // Warn user if they try to leave/refresh with unsaved changes
      React.useEffect(() => {
        const handleBeforeUnload = (e) => {
          if (hasUnsavedChanges) {
            e.preventDefault();
            e.returnValue = '';
            return '';
          }
        };
        
        window.addEventListener('beforeunload', handleBeforeUnload);
        return () => window.removeEventListener('beforeunload', handleBeforeUnload);
      }, [hasUnsavedChanges]);
      
      // Save data to localStorage effects
      React.useEffect(() => {
        saveToLocalStorage('projectCategories', projectCategories);
      }, [projectCategories]);
      
      React.useEffect(() => {
        saveToLocalStorage('teamMembers', teamMembers);
      }, [teamMembers]);
      
      React.useEffect(() => {
        saveToLocalStorage('currentProjects', currentProjects);
      }, [currentProjects]);
      
      React.useEffect(() => {
        saveToLocalStorage('semblanceOpportunities', semblanceOpportunities);
      }, [semblanceOpportunities]);
      
      React.useEffect(() => {
        saveToLocalStorage('pipelineProjects', pipelineProjects);
      }, [pipelineProjects]);
      
      React.useEffect(() => {
        saveToLocalStorage('resourcingInsights', resourcingInsights);
      }, [resourcingInsights]);
      
      React.useEffect(() => {
        saveToLocalStorage('internalActivities', internalActivities);
      }, [internalActivities]);
      
      // CALCULATIONS
      const totalTeamUtilisation = teamMembers.reduce((sum, member) => sum + member.utilisation, 0) / teamMembers.length;
      
      const confirmedRevenue = currentProjects
        .filter(project => project.status === 'Confirmed' || project.status === 'Ongoing')
        .reduce((sum, project) => sum + project.value, 0);
      
      const pipelineRevenue = currentProjects
        .filter(project => project.status === 'Pending' || project.status === 'Pitch')
        .reduce((sum, project) => sum + project.value, 0);
      
      const semblanceRevenue = semblanceOpportunities.reduce((sum, opp) => sum + opp.value, 0);
      
      const confirmedSemblanceRevenue = semblanceOpportunities
        .filter(opp => opp.status === 'Confirmed' || opp.status === 'In Progress')
        .reduce((sum, opp) => sum + opp.value, 0);
      
      const totalBusinessDevDays = internalActivities
        .filter(activity => activity.timeImpact === 'High')
        .length * 1.5 + internalActivities
        .filter(activity => activity.timeImpact === 'Medium')
        .length * 0.75;
      
      const alecTotalRequiredDays = currentProjects
        .filter(project => project.team.includes('Alec'))
        .length * 0.75 + totalBusinessDevDays;
      
      // Update the opportunity cost insight with the 50% conversion calculation
      React.useEffect(() => {
        // Only update if the data has been loaded
        if (semblanceRevenue && confirmedSemblanceRevenue) {
          const potentialRevenue = (semblanceRevenue * 0.5) / 1000;
          const currentContent = `Without additional resourcing, we risk losing £${potentialRevenue.toFixed(0)}k in potential Semblance revenue (assuming 50% conversion)`;
          
          // Find the opportunity cost insight
          const opportunityCostInsight = resourcingInsights.find(insight => insight.title === 'Opportunity cost');
          
          // Only update if the content needs to be changed
          if (opportunityCostInsight && opportunityCostInsight.content !== currentContent) {
            const updatedInsights = resourcingInsights.map(insight => {
              if (insight.title === 'Opportunity cost') {
                return { ...insight, content: currentContent };
              }
              return insight;
            });
            
            setResourcingInsights(updatedInsights);
          }
        }
      }, [semblanceRevenue, confirmedSemblanceRevenue, resourcingInsights]);
      
      // CHARTS DATA
      const teamUtilisationData = teamMembers.map(member => ({
        name: member.name,
        utilisation: member.utilisation,
        role: member.role
      }));
      
      const revenueBreakdownData = [
        { name: 'Confirmed Projects', value: confirmedRevenue },
        { name: 'Pipeline Projects', value: pipelineRevenue },
        { name: 'Semblance Opportunities', value: semblanceRevenue - confirmedSemblanceRevenue }
      ];
      
      const timeAllocationData = [
        { name: 'Project Work', value: 4 },
        { name: 'Business Development', value: totalBusinessDevDays / 12 },  // Averaged per week
        { name: 'Admin & Resourcing', value: 0.5 }
      ];
      
      const semblanceStatusData = [
        { 
          name: 'Confirmed', 
          value: semblanceOpportunities.filter(opp => opp.status === 'Confirmed')
            .reduce((sum, opp) => sum + opp.value, 0)
        },
        { 
          name: 'In Progress', 
          value: semblanceOpportunities.filter(opp => opp.status === 'In Progress')
            .reduce((sum, opp) => sum + opp.value, 0)
        },
        { 
          name: 'Pitch', 
          value: semblanceOpportunities.filter(opp => opp.status === 'Pitch')
            .reduce((sum, opp) => sum + opp.value, 0)
        },
        { 
          name: 'Prospect', 
          value: semblanceOpportunities.filter(opp => opp.status === 'Prospect')
            .reduce((sum, opp) => sum + opp.value, 0)
        }
      ];
      
      const COLORS = ['#0088FE', '#00C49F', '#FFBB28', '#FF8042', '#8884d8'];
      const STATUS_COLORS = {
        'Confirmed': '#4CAF50',
        'Ongoing': '#2196F3',
        'Pending': '#FF9800',
        'Pitch': '#9C27B0',
        'Prospect': '#607D8B',
        'In Progress': '#00BCD4',
        'Pipeline': '#E91E63',
        'Active Account': '#3F51B5'
      };
      
      return (
        <div className="neu-container p-6 mb-10">
          <div className="flex justify-between items-center">
            <div>
              <h1 className="text-2xl font-bold mb-1">BeSci, UX & AI Strategy Dashboard</h1>
              <h2 className="text-lg text-gray-600">Q3: 3-Month Time Horizon (April-June)</h2>
            </div>
            <div className="flex items-center space-x-3">
              {/* User role indicator */}
              <div className="flex items-center">
                <span className={`h-3 w-3 rounded-full mr-1 ${isAdmin ? 'bg-green-500' : 'bg-blue-500'}`}></span>
                <span className="text-sm text-gray-600">
                  {isAdmin ? 'Admin Mode' : 'View Only Mode'}
                </span>
              </div>
              
              {/* Logout button */}
              <button 
                className="px-3 py-1 text-sm neu-btn"
                onClick={handleLogout}
              >
                Logout
              </button>
              
              {/* Reset button - only for admins */}
              {isAdmin && (
                <button 
                  className="px-3 py-1 text-sm neu-btn neu-primary"
                  onClick={() => {
                    if(window.confirm('Are you sure you want to reset all data to default values? This cannot be undone.')) {
                      // Clear all localStorage data
                      Object.keys(localStorage).forEach(key => {
                        if(key.startsWith('oliverDashboard_')) {
                          localStorage.removeItem(key);
                        }
                      });
                      // Reset all state to defaults
                      setProjectCategories(defaultCategories);
                      setTeamMembers(defaultTeamMembers);
                      setCurrentProjects(defaultProjects);
                      setSemblanceOpportunities(defaultSemblanceOpportunities);
                      setPipelineProjects(defaultPipelineProjects);
                  setResourcingInsights(defaultResourcingInsights);
                  setInternalActivities(defaultInternalActivities);
                  showNotification('Data has been reset to defaults', 'info');
                }
              }}
            >
              Reset to Default Data
            </button>
          </div>
          
          <div className="flex mb-6 space-x-3 overflow-x-auto pb-2 mt-5">
            <button 
              className={`neu-btn px-4 py-2 whitespace-nowrap ${activeView === 'executive' ? 'neu-primary' : ''}`}
              onClick={() => setActiveView('executive')}
            >
              Executive Summary
            </button>
            <button 
              className={`neu-btn px-4 py-2 whitespace-nowrap ${activeView === 'capacity' ? 'neu-secondary' : ''}`}
              onClick={() => setActiveView('capacity')}
            >
              Team Capacity
            </button>
            <button 
              className={`neu-btn px-4 py-2 whitespace-nowrap ${activeView === 'projects' ? 'neu-accent1' : ''}`}
              onClick={() => setActiveView('projects')}
            >
              Current Projects
            </button>
            <button 
              className={`neu-btn px-4 py-2 whitespace-nowrap ${activeView === 'semblance' ? 'neu-accent4' : ''}`}
              onClick={() => setActiveView('semblance')}
            >
              Semblance Opportunities
            </button>
            <button 
              className={`neu-btn px-4 py-2 whitespace-nowrap ${activeView === 'pipeline' ? 'neu-accent2' : ''}`}
              onClick={() => setActiveView('pipeline')}
            >
              Pipeline & Biz Dev
            </button>
          </div>
          
          {activeView === 'executive' && (
            <div className="space-y-6">
              <div className="neu-card p-5">
                <h2 className="text-xl font-semibold mb-4">Executive Summary</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
                  <div className="neu-card-inner neu-accent1 p-5">
                    <h3 className="font-medium text-blue-800">Team Capacity</h3>
                    <p className="text-3xl font-bold">{Math.round(totalTeamUtilisation)}%</p>
                    <p className="text-sm text-gray-700">Average utilisation</p>
                    <p className="mt-2 text-sm text-blue-800 font-medium">Alec at {teamMembers[0].utilisation}% capacity</p>
                  </div>
                  
                  <div className="neu-card-inner neu-accent3 p-5">
                    <h3 className="font-medium text-green-800">Revenue Confirmed</h3>
                    <p className="text-3xl font-bold">£{(confirmedRevenue/1000).toFixed(0)}k</p>
                    <p className="text-sm text-gray-700">Current projects</p>
                    <p className="mt-2 text-sm text-green-800 font-medium">+ £{(confirmedSemblanceRevenue/1000).toFixed(0)}k from Semblance</p>
                  </div>
                  
                  <div className="neu-card-inner neu-accent4 p-5">
                    <h3 className="font-medium text-purple-800">Opportunity Pipeline</h3>
                    <p className="text-3xl font-bold">£{((pipelineRevenue + semblanceRevenue - confirmedSemblanceRevenue)/1000).toFixed(0)}k</p>
                    <p className="text-sm text-gray-700">Near-term opportunities</p>
                    <p className="mt-2 text-sm text-purple-800 font-medium">+ £{((pipelineProjects.reduce((sum, proj) => sum + proj.value, 0))/1000).toFixed(0)}k longer-term pipeline</p>
                  </div>
                </div>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-5">
                <div className="neu-card p-5">
                  <h2 className="text-lg font-semibold mb-4">Team Utilisation</h2>
                  <div className="h-64">
                    <ResponsiveContainer width="100%" height="100%">
                      <BarChart
                        data={teamUtilisationData}
                        margin={{ top: 5, right: 30, left: 20, bottom: 5 }}
                        layout="vertical"
                      >
                        <CartesianGrid strokeDasharray="3 3" horizontal={false} />
                        <XAxis type="number" domain={[0, 150]} />
                        <YAxis dataKey="name" type="category" />
                        <Tooltip 
                          formatter={(value, name, props) => [`${value}%`, 'Utilisation']}
                          labelFormatter={(value) => `${value} - ${teamUtilisationData.find(d => d.name === value)?.role}`}
                          wrapperClassName="tooltip-wrapper"
                        />
                        <Bar dataKey="utilisation" fill="#8884d8">
                          {teamUtilisationData.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={entry.utilisation > 110 ? '#ef4444' : entry.utilisation > 100 ? '#f97316' : '#22c55e'} />
                          ))}
                        </Bar>
                      </BarChart>
                    </ResponsiveContainer>
                  </div>
                </div>
                
                <div className="neu-card p-5">
                  <h2 className="text-lg font-semibold mb-4">Revenue Breakdown</h2>
                  <div className="h-64">
                    <ResponsiveContainer width="100%" height="100%">
                      <PieChart>
                        <Pie
                          data={revenueBreakdownData}
                          cx="50%"
                          cy="50%"
                          labelLine={false}
                          outerRadius={80}
                          fill="#8884d8"
                          dataKey="value"
                          label={({name, value}) => `${name}: £${(value/1000).toFixed(0)}k`}
                          labelStyle={{ fontSize: '6px', fill: '#333' }}
                        >
                          {revenueBreakdownData.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} />
                          ))}
                        </Pie>
                        <Tooltip formatter={(value) => `£${(value/1000).toFixed(0)}k`} />
                        <Legend />
                      </PieChart>
                    </ResponsiveContainer>
                  </div>
                </div>
              </div>
              
              <div className="neu-card p-5">
                <h2 className="text-lg font-semibold mb-4">Resourcing Needs Assessment</h2>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-5">
                  <div className="neu-card-inner neu-primary p-4">
                    <h3 className="font-medium text-red-800">Critical Need</h3>
                    <p>Alec at {teamMembers[0].utilisation}% capacity with key revenue-generating activities</p>
                    <p className="mt-2 text-sm">Recommend 1 senior hire to support Semblance and client work</p>
                  </div>
                  
                  <div className="neu-card-inner neu-accent2 p-4">
                    <h3 className="font-medium text-amber-800">Growth Opportunity</h3>
                    <p>£{((semblanceRevenue - confirmedSemblanceRevenue)/1000).toFixed(0)}k in Semblance opportunities</p>
                    <p className="mt-2 text-sm">Dedicated resource could accelerate conversion</p>
                  </div>
                  
                  <div className="neu-card-inner neu-accent1 p-4">
                    <h3 className="font-medium text-blue-800">Business Case</h3>
                    <p>New hire ROI positive with just 2-3 Semblance clients</p>
                    <p className="mt-2 text-sm">Would also support £{(pipelineRevenue/1000).toFixed(0)}k in pending work</p>
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {activeView === 'capacity' && (
            <div className="space-y-6">
              <div className="neu-card p-5">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-semibold">Team Capacity Breakdown</h2>
                  {!isEditing && isAdmin && (
                    <button 
                      className="neu-btn neu-secondary px-4 py-2 text-white"
                      onClick={() => {
                        setOriginalData(JSON.parse(JSON.stringify(teamMembers)));
                        setIsEditing(true);
                      }}
                    >
                      Edit
                    </button>
                  )}
                  {isEditing && (
                    <div className="flex space-x-3 items-center">
                      {hasUnsavedChanges && (
                        <span className="text-amber-600 text-sm mr-2">
                          <span className="inline-block w-2 h-2 bg-amber-500 rounded-full mr-1"></span>
                          Unsaved changes
                        </span>
                      )}
                      <button 
                        className="neu-btn neu-accent3 px-4 py-2"
                        onClick={() => {
                          setIsEditing(false);
                          setOriginalData(null);
                          showNotification('Changes saved to localStorage');
                        }}
                      >
                        Save Changes
                      </button>
                      <button 
                        className="neu-btn neu-primary px-4 py-2 text-white"
                        onClick={() => {
                          setTeamMembers(originalData);
                          setIsEditing(false);
                          setOriginalData(null);
                        }}
                      >
                        Cancel
                      </button>
                    </div>
                  )}
                </div>
                
                {teamMembers.map((member, idx) => (
                  <div key={idx} className="mb-6">
                    <div className="flex justify-between items-center mb-2">
                      <h3 className="font-medium">
                        {isEditing ? (
                          <div className="flex space-x-2">
                            <input 
                              type="text" 
                              className="neu-input px-2 py-1" 
                              value={member.name}
                              onChange={(e) => {
                                const updatedMembers = [...teamMembers];
                                updatedMembers[idx].name = e.target.value;
                                setTeamMembers(updatedMembers);
                              }}
                            />
                            <input 
                              type="text" 
                              className="neu-input px-2 py-1" 
                              value={member.role}
                              onChange={(e) => {
                                const updatedMembers = [...teamMembers];
                                updatedMembers[idx].role = e.target.value;
                                setTeamMembers(updatedMembers);
                              }}
                            />
                          </div>
                        ) : (
                          `${member.name} (${member.role})`
                        )}
                      </h3>
                      <div className="flex items-center space-x-2">
                        {isEditing && (
                          <div className="flex items-center space-x-2">
                            <span className="text-sm text-gray-500">Working Days:</span>
                            <input 
                              type="number" 
                              className="neu-input px-2 py-1 w-16 text-right" 
                              value={member.capacity}
                              onChange={(e) => {
                                const updatedMembers = [...teamMembers];
                                updatedMembers[idx].capacity = Number(e.target.value);
                                // Recalculate utilisation
                                updatedMembers[idx].utilisation = Math.round((updatedMembers[idx].totalDays / updatedMembers[idx].capacity) * 100);
                                setTeamMembers(updatedMembers);
                              }}
                            />
                          </div>
                        )}
                        <div className="flex flex-col items-end">
                          <span className="status-badge text-xs" style={{
                            backgroundColor: member.utilisation > 110 ? '#ff5252' : 
                                          member.utilisation > 100 ? '#ffcc01' : 
                                          '#32ff7e',
                            color: (member.utilisation <= 110 && member.utilisation >= 100) || member.utilisation <= 100 ? 'black' : 'white'
                          }}>
                            {member.utilisation}% utilisation
                          </span>
                          {!isEditing && (
                            <span className="text-xs text-gray-500 mt-1">{member.capacity} days capacity</span>
                          )}
                        </div>
                        {isEditing && (
                          <button 
                            className="text-red-500 hover:text-red-700 ml-2"
                            onClick={() => {
                              const updatedMembers = [...teamMembers];
                              updatedMembers.splice(idx, 1);
                              setTeamMembers(updatedMembers);
                            }}
                          >
                            Delete
                          </button>
                        )}
                      </div>
                    </div>
                    
                    <div className="bg-gray-200 rounded h-4 mb-4 relative thick-border overflow-hidden">
                      {/* Show all projects as equal segments */}
                      <div className="flex h-full w-full">
                        {member.allocations.map((allocation, allocIdx) => {
                          // Find the category for this allocation
                          const category = projectCategories.find(cat => cat.id === allocation.categoryId) || 
                                          { color: COLORS[allocIdx % COLORS.length] }; // Fallback
                          // Use custom color if available, otherwise use category color
                          const color = allocation.customColor || category.color;
                          
                          // Each project gets an equal portion of the bar
                          const segmentWidth = 100 / member.allocations.length;
                          
                          return (
                            <div 
                              key={`${member.name}-${allocIdx}-segment`}
                              className="h-full"
                              style={{ 
                                width: `${segmentWidth}%`,
                                backgroundColor: color
                              }}
                            />
                          );
                        })}
                      </div>
                      
                      {/* Removed 100% capacity marker as requested */}
                      
                      {/* Percentage label showing utilization */}
                      <div 
                        className="absolute right-2 top-0 bottom-0 flex items-center text-xs font-bold"
                        style={{ color: 'white' }}
                      >
                        {member.utilisation}%
                      </div>
                    </div>
                    
                    <div className="text-sm space-y-1">
                      {isEditing ? (
                        <div className="space-y-2 mt-2 mb-2">
                          {/* Category management removed */}
                          
                          {member.allocations.map((allocation, allocIdx) => {
                            // Find the category for this allocation
                            const category = projectCategories.find(cat => cat.id === allocation.categoryId) || 
                                            { id: null, color: COLORS[allocIdx % COLORS.length] }; // Fallback
                            
                            return (
                              <div key={`${member.name}-${allocIdx}-edit`} className="flex items-center space-x-2">
                                <div className="w-3 h-3 mr-1" style={{ backgroundColor: category.color }}></div>
                                <input 
                                  type="text" 
                                  className="neu-input px-2 py-1 flex-grow" 
                                  placeholder="Project name"
                                  value={allocation.project}
                                  onChange={(e) => {
                                    const updatedMembers = [...teamMembers];
                                    updatedMembers[idx].allocations[allocIdx].project = e.target.value;
                                    setTeamMembers(updatedMembers);
                                  }}
                                />
                                <select
                                  className="neu-input px-2 py-1"
                                  value={allocation.categoryId || ''}
                                  onChange={(e) => {
                                    const updatedMembers = [...teamMembers];
                                    updatedMembers[idx].allocations[allocIdx].categoryId = e.target.value ? Number(e.target.value) : null;
                                    setTeamMembers(updatedMembers);
                                  }}
                                >
                                  <option value="">Select Category</option>
                                  {projectCategories.map(cat => (
                                    <option key={cat.id} value={cat.id}>{cat.name}</option>
                                  ))}
                                </select>
                                <div className="flex items-center">
                                  <input 
                                    type="number" 
                                    className="neu-input px-2 py-1 w-16 text-right" 
                                    placeholder="Days"
                                    value={allocation.days}
                                    step="0.5"
                                    min="0"
                                    onChange={(e) => {
                                      const updatedMembers = [...teamMembers];
                                      updatedMembers[idx].allocations[allocIdx].days = Number(e.target.value);
                                      
                                      // Recalculate totalDays and utilisation
                                      updatedMembers[idx].totalDays = updatedMembers[idx].allocations.reduce(
                                        (sum, alloc) => sum + alloc.days, 0
                                      );
                                      updatedMembers[idx].utilisation = Math.round(
                                        (updatedMembers[idx].totalDays / updatedMembers[idx].capacity) * 100
                                      );
                                      
                                      setTeamMembers(updatedMembers);
                                    }}
                                  />
                                  <span className="ml-1">day(s)</span>
                                </div>
                                <button 
                                  className="text-red-500 hover:text-red-700"
                                  onClick={() => {
                                    const updatedMembers = [...teamMembers];
                                    updatedMembers[idx].allocations.splice(allocIdx, 1);
                                    
                                    // Recalculate totalDays and utilisation
                                    updatedMembers[idx].totalDays = updatedMembers[idx].allocations.reduce(
                                      (sum, alloc) => sum + alloc.days, 0
                                    );
                                    updatedMembers[idx].utilisation = Math.round(
                                      (updatedMembers[idx].totalDays / updatedMembers[idx].capacity) * 100
                                    );
                                    
                                    setTeamMembers(updatedMembers);
                                  }}
                                >
                                  Delete
                                </button>
                              </div>
                            );
                          })}
                          <button 
                            className="mt-2 py-1 px-3 bg-blue-100 hover:bg-blue-200 text-blue-800 rounded text-sm"
                            onClick={() => {
                              const updatedMembers = [...teamMembers];
                              // Select a random existing category
                              const randomCategoryIndex = Math.floor(Math.random() * projectCategories.length);
                              const selectedCategory = projectCategories[randomCategoryIndex];
                              
                              // Add allocation with the existing category but with custom color
                              updatedMembers[idx].allocations.push({
                                project: '',
                                days: 0,
                                categoryId: selectedCategory.id,
                                // Store a custom color for this allocation that overrides the category color
                                customColor: generateRandomColor()
                              });
                              setTeamMembers(updatedMembers);
                            }}
                          >
                            + Add Project Allocation
                          </button>
                        </div>
                      ) : (
                        member.allocations.map((allocation, allocIdx) => {
                          const category = projectCategories.find(cat => cat.id === allocation.categoryId) || 
                                          { color: COLORS[allocIdx % COLORS.length] }; // Fallback
                          // Use custom color if available, otherwise use category color
                          const color = allocation.customColor || category.color;
                          return (
                            <div key={`${member.name}-${allocIdx}-legend`} className="flex items-center">
                              <div className="w-3 h-3 mr-2" style={{ backgroundColor: color }}></div>
                              <span>{allocation.project}: {allocation.days} day{allocation.days !== 1 ? 's' : ''}</span>
                              <span className="ml-2 text-xs text-gray-500">({category.name || 'Uncategorized'})</span>
                            </div>
                          );
                        })
                      )}
                    </div>
                  </div>
                ))}
                
                {isEditing && (
                  <div className="mt-4">
                    <button 
                      className="w-full py-2 neu-btn text-gray-800 text-center"
                      onClick={() => {
                        setTeamMembers([...teamMembers, {
                          name: 'New Team Member',
                          role: 'Role',
                          allocations: [],
                          totalDays: 0,
                          capacity: 5,
                          utilisation: 0
                        }]);
                      }}
                    >
                      + Add New Team Member
                    </button>
                  </div>
                )}
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-5 mt-5">
                <div className="neu-card p-5">
                  <h2 className="text-lg font-semibold mb-4">Alec's Time Allocation by Category</h2>
                  <div className="h-64">
                    <ResponsiveContainer width="100%" height="100%">
                      <PieChart>
                        <Pie
                          data={(() => {
                            // Group allocations by category
                            const categoryMap = new Map();
                            
                            teamMembers[0].allocations.forEach(allocation => {
                              const categoryId = allocation.categoryId;
                              const category = projectCategories.find(cat => cat.id === categoryId);
                              
                              if (category) {
                                if (!categoryMap.has(categoryId)) {
                                  categoryMap.set(categoryId, {
                                    name: category.name,
                                    days: 0,
                                    color: category.color,
                                    categoryId: categoryId
                                  });
                                }
                                
                                const categoryData = categoryMap.get(categoryId);
                                categoryData.days += allocation.days;
                              }
                            });
                            
                            return Array.from(categoryMap.values());
                          })()}
                          cx="50%"
                          cy="50%"
                          labelLine={false}
                          outerRadius={80}
                          fill="#8884d8"
                          nameKey="name"
                          dataKey="days"
                          label={({name, days}) => `${name}: ${days.toFixed(1)}d`}
                          labelStyle={{ fontSize: '6px', fill: '#333' }}
                        >
                          {projectCategories.map((category) => (
                            <Cell key={`cell-${category.id}`} fill={category.color} />
                          ))}
                        </Pie>
                        <Tooltip 
                          formatter={(value) => `${value.toFixed(1)} day${value !== 1 ? 's' : ''}`} 
                          labelFormatter={(name) => name} 
                        />
                        <Legend dataKey="name" />
                      </PieChart>
                    </ResponsiveContainer>
                  </div>
                  
                  <div className="mt-4">
                    <h3 className="text-sm font-medium mb-2">Project breakdown</h3>
                    <div className="space-y-1">
                      {teamMembers[0].allocations.map((allocation, idx) => {
                        const category = projectCategories.find(cat => cat.id === allocation.categoryId) || 
                                        { color: COLORS[idx % COLORS.length] };
                        return (
                          <div key={idx} className="flex items-center">
                            <div className="w-3 h-3 mr-2" style={{ backgroundColor: category.color }}></div>
                            <span>{allocation.project}: {allocation.days} day{allocation.days !== 1 ? 's' : ''}</span>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                  
                  <div className="mt-4 p-3 neu-card-inner neu-accent2">
                    <p className="text-sm text-amber-800">
                      <strong>Note:</strong> Working {teamMembers[0].totalDays.toFixed(1)} days/week vs. {teamMembers[0].capacity} days contracted
                    </p>
                  </div>
                </div>
                
                <div className="neu-card p-5">
                  <div className="mb-4">
                    <div className="flex items-center">
                      <h2 className="text-lg font-semibold mr-2">Required vs. Available Time</h2>
                      <div className="tooltip-container">
                        <span className="cursor-help text-blue-500">
                          <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                          </svg>
                        </span>
                        <div className="tooltip-box w-80 bottom-full left-1/2 transform -translate-x-1/2 mb-2">
                          <p className="text-sm mb-2"><strong>Understanding Time Requirements:</strong></p>
                          <p className="text-sm mb-2">• <strong>Available:</strong> 4 days per week (Alec's capacity)</p>
                          <p className="text-sm mb-2">• <strong>Required:</strong> 8.75 days per week total, from:</p>
                          <p className="text-sm mb-2">&nbsp;&nbsp;- 6 days for projects (8 projects × 0.75 days each)</p>
                          <p className="text-sm mb-2">&nbsp;&nbsp;- 2.75 days for business development activities</p>
                          <p className="text-sm"><strong>Bottom line:</strong> Alec is over-allocated by 4.75 days per week, indicating a need for additional resources or reduced workload.</p>
                          <div className="absolute w-4 h-4 bg-white border-r-2 border-b-2 border-black transform rotate-45 -bottom-2 left-1/2 -ml-2"></div>
                        </div>
                      </div>
                    </div>
                    <p className="text-sm text-gray-600 italic mt-1">Projections based on upcoming pipeline opportunities and scheduled business development activities, not just current active projects.</p>
                  </div>
                  <div className="space-y-4">
                    <div>
                      <h3 className="text-sm font-medium mb-1">Alec - required days per week</h3>
                      <div className="flex mb-1">
                        {/* Create an array of 5 boxes (0-4 days capacity) */}
                        {Array.from({ length: 5 }).map((_, i) => {
                          // Determine what fraction of this box should be filled
                          const isFilled = i < Math.floor(alecTotalRequiredDays);
                          const isPartial = i === Math.floor(alecTotalRequiredDays) && alecTotalRequiredDays % 1 > 0;
                          const partialWidth = (alecTotalRequiredDays % 1) * 100;
                          
                          // Determine styling based on whether this box is within capacity
                          const isOverCapacity = i >= 4; // 4 days is Alec's capacity
                          const boxBaseClass = "w-1/5 h-12 border border-gray-300 relative";
                          const boxFillClass = isOverCapacity ? "bg-red-500" : "bg-blue-600";
                          const partialBoxStyle = isPartial ? {
                            width: `${partialWidth}%`,
                            height: '100%',
                            position: 'absolute',
                            top: 0,
                            left: 0
                          } : {};
                          
                          return (
                            <div 
                              key={i} 
                              className={`${boxBaseClass} ${i === 0 ? "rounded-l" : ""} ${i === 4 ? "rounded-r" : ""}`}
                            >
                              {isFilled && <div className={`${boxFillClass} h-full`}></div>}
                              {isPartial && <div className={boxFillClass} style={partialBoxStyle}></div>}
                              
                              {/* Capacity limit indicator */}
                              {i === 3 && (
                                <div className="absolute top-0 right-0 h-full w-0.5 bg-black z-10"></div>
                              )}
                              
                              {/* Day number labels */}
                              <div className="absolute bottom-0 left-1/2 transform -translate-x-1/2 -mb-5 text-xs">{i + 1}</div>
                            </div>
                          );
                        })}
                      </div>
                      <div className="flex justify-between mt-6 text-sm">
                        <div className="flex items-center">
                          <div className="w-3 h-3 bg-blue-600 mr-1"></div>
                          <span>Available ({teamMembers[0].capacity} days)</span>
                        </div>
                        <div className="flex items-center">
                          <div className="w-3 h-3 bg-red-500 mr-1"></div>
                          <span>Over Capacity ({Math.max(0, (alecTotalRequiredDays - teamMembers[0].capacity)).toFixed(1)} days)</span>
                        </div>
                      </div>
                      <p className="text-sm mt-2">Estimated need: {alecTotalRequiredDays.toFixed(1)} days per week</p>
                    </div>
                    
                    <div>
                      <h3 className="text-sm font-medium mb-1">Current team capacity utilisation</h3>
                      <div className="w-full bg-gray-200 rounded-full h-6">
                        <div className={`h-6 rounded-full ${totalTeamUtilisation > 110 ? 'bg-red-500' : totalTeamUtilisation > 100 ? 'bg-amber-500' : 'bg-green-500'}`} style={{ width: `${Math.min(totalTeamUtilisation, 100)}%` }}></div>
                      </div>
                      <div className="flex justify-between text-xs mt-1">
                        <span>0%</span>
                        <span>25%</span>
                        <span>50%</span>
                        <span>75%</span>
                        <span>100%</span>
                      </div>
                      <p className="text-sm mt-2">Team average: {Math.round(totalTeamUtilisation)}% capacity</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {activeView === 'projects' && (
            <div className="neu-card p-5">
              <div className="flex justify-between items-center mb-4">
                <h2 className="text-xl font-semibold">Current Projects</h2>
                {!isEditing && (
                      <button 
                        className="neu-btn neu-secondary px-4 py-2 text-white"
                        onClick={() => {
                        setOriginalData(JSON.parse(JSON.stringify(currentProjects)));
                        setIsEditing(true);
                      }}
                    >
                      Edit
                    </button>
                )}
                {isEditing && (
                  <div className="flex space-x-2">
                    <button 
                      className="neu-btn neu-accent3 px-4 py-2"
                      onClick={() => {
                        setIsEditing(false);
                        setOriginalData(null);
                      }}
                    >
                      Save Changes
                    </button>
                    <button 
                      className="neu-btn neu-primary px-4 py-2 text-white"
                      onClick={() => {
                        setCurrentProjects(originalData);
                        setIsEditing(false);
                        setOriginalData(null);
                      }}
                    >
                      Cancel
                    </button>
                  </div>
                )}
              </div>
              <div className="overflow-x-auto">
                <table className="min-w-full neu-table">
                  <thead className="bg-gray-100">
                    <tr>
                      {isEditing && <th className="py-2 px-4 border-b text-left">Actions</th>}
                      <th className="py-2 px-4 border-b text-left">Project</th>
                      <th className="py-2 px-4 border-b text-left">Timeframe</th>
                      <th className="py-2 px-4 border-b text-left">Status</th>
                      <th className="py-2 px-4 border-b text-right">Value</th>
                      <th className="py-2 px-4 border-b text-left">Team</th>
                      <th className="py-2 px-4 border-b text-left">Notes</th>
                    </tr>
                  </thead>
                  <tbody>
                    {currentProjects.map((project, index) => (
                      <tr key={project.id}>
                        {isEditing && (
                          <td className="py-2 px-4 border-b">
                            <button 
                              className="text-red-500 hover:text-red-700"
                              onClick={() => {
                                const updatedProjects = [...currentProjects];
                                updatedProjects.splice(index, 1);
                                setCurrentProjects(updatedProjects);
                              }}
                            >
                              Delete
                            </button>
                          </td>
                        )}
                        <td className="py-2 px-4 border-b font-medium">
                          {isEditing ? (
                            <input 
                              type="text" 
                              className="neu-input px-2 py-1 w-full" 
                              value={project.name}
                              onChange={(e) => {
                                const updatedProjects = [...currentProjects];
                                updatedProjects[index].name = e.target.value;
                                setCurrentProjects(updatedProjects);
                              }}
                            />
                          ) : (
                            project.name
                          )}
                        </td>
                        <td className="py-2 px-4 border-b">
                          {isEditing ? (
                            <div className="flex flex-col space-y-1">
                              <div className="flex items-center">
                                <span className="text-xs text-gray-500 w-16">Start:</span>
                                <input 
                                  type="date" 
                                  className="neu-input px-2 py-1" 
                                  value={project.startDate}
                                  onChange={(e) => {
                                    const updatedProjects = [...currentProjects];
                                    updatedProjects[index].startDate = e.target.value;
                                    // Update timeframe for backward compatibility
                                    const startDate = new Date(e.target.value);
                                    const endDate = new Date(updatedProjects[index].endDate);
                                    updatedProjects[index].timeframe = `${startDate.toLocaleString('default', { month: 'long' })} to ${endDate.toLocaleString('default', { month: 'long' })}`;
                                    setCurrentProjects(updatedProjects);
                                  }}
                                />
                              </div>
                              <div className="flex items-center">
                                <span className="text-xs text-gray-500 w-16">End:</span>
                                <input 
                                  type="date" 
                                  className="neu-input px-2 py-1" 
                                  value={project.endDate}
                                  onChange={(e) => {
                                    const updatedProjects = [...currentProjects];
                                    updatedProjects[index].endDate = e.target.value;
                                    // Update timeframe for backward compatibility
                                    const startDate = new Date(updatedProjects[index].startDate);
                                    const endDate = new Date(e.target.value);
                                    updatedProjects[index].timeframe = `${startDate.toLocaleString('default', { month: 'long' })} to ${endDate.toLocaleString('default', { month: 'long' })}`;
                                    setCurrentProjects(updatedProjects);
                                  }}
                                />
                              </div>
                            </div>
                          ) : (
                            project.timeframe
                          )}
                        </td>
                        <td className="py-2 px-4 border-b">
                          {isEditing ? (
                            <select 
                              className="neu-input px-2 py-1 w-full"
                              value={project.status}
                              onChange={(e) => {
                                const updatedProjects = [...currentProjects];
                                updatedProjects[index].status = e.target.value;
                                setCurrentProjects(updatedProjects);
                              }}
                            >
                              {Object.keys(STATUS_COLORS).map(status => (
                                <option key={status} value={status}>{status}</option>
                              ))}
                            </select>
                          ) : (
                            <span className="status-badge text-xs" style={{
                              backgroundColor: STATUS_COLORS[project.status],
                              color: 'white'
                            }}>
                              {project.status}
                            </span>
                          )}
                        </td>
                        <td className="py-2 px-4 border-b text-right">
                          {isEditing ? (
                            <div className="flex items-center justify-end">
                              <span className="mr-1 text-gray-600">£</span>
                              <input 
                                type="number" 
                                className="neu-input px-2 py-1 w-24 text-right" 
                                value={project.value}
                                onChange={(e) => {
                                  const updatedProjects = [...currentProjects];
                                  updatedProjects[index].value = Number(e.target.value);
                                  setCurrentProjects(updatedProjects);
                                }}
                              />
                            </div>
                          ) : (
                            `£${(project.value/1000).toFixed(0)}k`
                          )}
                        </td>
                        <td className="py-2 px-4 border-b">
                          {isEditing ? (
                            <input 
                              type="text" 
                              className="neu-input px-2 py-1 w-full" 
                              value={project.team.join(', ')}
                              onChange={(e) => {
                                const updatedProjects = [...currentProjects];
                                updatedProjects[index].team = e.target.value.split(',').map(item => item.trim());
                                setCurrentProjects(updatedProjects);
                              }}
                            />
                          ) : (
                            project.team.join(', ')
                          )}
                        </td>
                        <td className="py-2 px-4 border-b text-sm">
                          {isEditing ? (
                            <input 
                              type="text" 
                              className="neu-input px-2 py-1 w-full" 
                              value={project.notes || ''}
                              onChange={(e) => {
                                const updatedProjects = [...currentProjects];
                                updatedProjects[index].notes = e.target.value;
                                setCurrentProjects(updatedProjects);
                              }}
                            />
                          ) : (
                            project.notes
                          )}
                        </td>
                      </tr>
                    ))}
                    {isEditing && (
                      <tr>
                        <td colSpan={7} className="py-2 px-4 border-b">
                          <button 
                            className="w-full py-2 neu-btn text-gray-800 text-center"
                            onClick={() => {
                              const newId = Math.max(...currentProjects.map(p => p.id), 0) + 1;
                              setCurrentProjects([...currentProjects, {
                                id: newId,
                                name: '',
                                timeframe: '',
                                value: 0,
                                status: 'Pending',
                                notes: '',
                                team: []
                              }]);
                            }}
                          >
                            + Add New Project
                          </button>
                        </td>
                      </tr>
                    )}
                  </tbody>
                  <tfoot className="bg-gray-50">
                    <tr>
                      <td className="py-2 px-4 border-b font-medium" colSpan="3">Total</td>
                      <td className="py-2 px-4 border-b text-right font-medium">£{(currentProjects.reduce((sum, project) => sum + project.value, 0)/1000).toFixed(0)}k</td>
                      <td className="py-2 px-4 border-b" colSpan="2"></td>
                    </tr>
                  </tfoot>
                </table>
              </div>
              
              <div className="space-y-6 mt-6">
                <div className="neu-card p-5">
                  <h3 className="text-lg font-semibold mb-4">Projects by Status</h3>
                  <div className="h-64">
                    <ResponsiveContainer width="100%" height="100%">
                      <PieChart>
                        <Pie
                          data={[
                            { 
                              name: 'Confirmed', 
                              value: currentProjects.filter(p => p.status === 'Confirmed').reduce((sum, p) => sum + p.value, 0) 
                            },
                            { 
                              name: 'Ongoing', 
                              value: currentProjects.filter(p => p.status === 'Ongoing').reduce((sum, p) => sum + p.value, 0) 
                            },
                            { 
                              name: 'Pending', 
                              value: currentProjects.filter(p => p.status === 'Pending').reduce((sum, p) => sum + p.value, 0) 
                            },
                            { 
                              name: 'Pitch', 
                              value: currentProjects.filter(p => p.status === 'Pitch').reduce((sum, p) => sum + p.value, 0) 
                            }
                          ]}
                          cx="50%"
                          cy="50%"
                          labelLine={false}
                          outerRadius={80}
                          fill="#8884d8"
                          dataKey="value"
                          label={({name, value}) => `${name}: £${(value/1000).toFixed(0)}k`}
                          labelStyle={{ fontSize: '6px', fill: '#333' }}
                        >
                          {Object.keys(STATUS_COLORS).map((status, index) => (
                            <Cell key={`cell-${index}`} fill={STATUS_COLORS[status]} />
                          ))}
                        </Pie>
                        <Tooltip formatter={(value) => `£${(value/1000).toFixed(0)}k`} />
                        <Legend />
                      </PieChart>
                    </ResponsiveContainer>
                  </div>
                </div>
                
                <div className="neu-card p-5">
                  <h3 className="text-lg font-semibold mb-4">Project Timeline (Gantt Chart)</h3>
                  <div className="h-64 overflow-y-auto">
                    {/* Timeline header - months */}
                    <div className="flex border-b mb-2 sticky top-0 bg-white z-10">
                      <div className="w-1/4 font-medium px-2">Project</div>
                      <div className="w-3/4 flex">
                        {['Apr', 'May', 'Jun', 'Jul'].map((month, idx) => (
                          <div key={month} className="flex-1 text-center text-sm font-medium">{month}</div>
                        ))}
                      </div>
                    </div>
                    
                    {/* Project rows */}
                    {currentProjects.map((project, idx) => {
                      // Calculate position and width based on dates
                      const startDate = new Date(project.startDate);
                      const endDate = new Date(project.endDate);
                      
                      // Calculate position (0-100%) based on April 1 to July 31 range
                      const timelineStart = new Date('2025-04-01');
                      const timelineEnd = new Date('2025-07-31');
                      const timelineRange = timelineEnd - timelineStart;
                      
                      const barStart = Math.max(0, (startDate - timelineStart) / timelineRange * 100);
                      const barWidth = Math.min(100 - barStart, (endDate - startDate) / timelineRange * 100);
                      
                      return (
                        <div key={idx} className="flex items-center mb-3 hover:bg-gray-50">
                          <div className="w-1/4 px-2">
                            <div className="font-medium text-sm truncate">{project.name}</div>
                            <div className="text-xs text-gray-500">£{(project.value/1000).toFixed(0)}k</div>
                          </div>
                          <div className="w-3/4 h-8 relative">
                            {/* Timeline bar */}
                            <div 
                              className="absolute h-6 top-1 rounded"
                              style={{
                                left: `${barStart}%`,
                                width: `${barWidth}%`,
                                backgroundColor: STATUS_COLORS[project.status],
                                opacity: 0.8
                              }}
                            >
                              <div className="absolute inset-0 flex items-center justify-center text-xs text-white font-medium">
                                {project.timeframe}
                              </div>
                            </div>
                            
                            {/* Month dividers */}
                            <div className="absolute inset-0 flex pointer-events-none">
                              <div className="flex-1 border-r border-gray-200"></div>
                              <div className="flex-1 border-r border-gray-200"></div>
                              <div className="flex-1 border-r border-gray-200"></div>
                              <div className="flex-1"></div>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                  
                  {/* Legend */}
                  <div className="mt-4 flex flex-wrap gap-3">
                    {Object.entries(STATUS_COLORS)
                      .filter(([status]) => currentProjects.some(p => p.status === status))
                      .map(([status, color]) => (
                        <div key={status} className="flex items-center">
                          <div className="w-3 h-3 mr-1 rounded" style={{ backgroundColor: color }}></div>
                          <span className="text-xs">{status}</span>
                        </div>
                      ))
                    }
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {activeView === 'semblance' && (
            <div className="space-y-4">
              <div className="neu-card p-5">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-semibold">Semblance Opportunities</h2>
                  <div className="flex items-center space-x-2">
                    <div className="p-2 neu-card-inner neu-accent1">
                      <span className="text-blue-800 font-medium">Total potential: £{(semblanceOpportunities.reduce((sum, opp) => sum + opp.value, 0)/1000).toFixed(0)}k</span>
                    </div>
                    {!isEditing && (
                      <button 
                        className="neu-btn neu-secondary px-4 py-2 text-white"
                        onClick={() => {
                          setOriginalData(JSON.parse(JSON.stringify(semblanceOpportunities)));
                          setIsEditing(true);
                        }}
                      >
                        Edit
                      </button>
                    )}
                    {isEditing && (
                      <div className="flex space-x-2">
                        <button 
                          className="neu-btn neu-accent3 px-4 py-2"
                          onClick={() => {
                            setIsEditing(false);
                            setOriginalData(null);
                          }}
                        >
                          Save Changes
                        </button>
                        <button 
                          className="neu-btn neu-primary px-4 py-2 text-white"
                          onClick={() => {
                            setSemblanceOpportunities(originalData);
                            setIsEditing(false);
                            setOriginalData(null);
                          }}
                        >
                          Cancel
                        </button>
                      </div>
                    )}
                  </div>
                </div>
                
                <div className="overflow-x-auto">
                  <table className="min-w-full neu-table">
                    <thead className="bg-gray-100">
                      <tr>
                        {isEditing && <th className="py-2 px-4 border-b text-left">Actions</th>}
                        <th className="py-2 px-4 border-b text-left">Client</th>
                        <th className="py-2 px-4 border-b text-left">Status</th>
                        <th className="py-2 px-4 border-b text-right">Value</th>
                        <th className="py-2 px-4 border-b text-left">Notes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {semblanceOpportunities.map((opp, idx) => (
                        <tr key={idx}>
                          {isEditing && (
                            <td className="py-2 px-4 border-b">
                              <button 
                                className="text-red-500 hover:text-red-700"
                                onClick={() => {
                                  const updatedOpportunities = [...semblanceOpportunities];
                                  updatedOpportunities.splice(idx, 1);
                                  setSemblanceOpportunities(updatedOpportunities);
                                }}
                              >
                                Delete
                              </button>
                            </td>
                          )}
                          <td className="py-2 px-4 border-b font-medium">
                            {isEditing ? (
                              <input 
                                type="text" 
                                className="neu-input px-2 py-1 w-full" 
                                value={opp.client}
                                onChange={(e) => {
                                  const updatedOpportunities = [...semblanceOpportunities];
                                  updatedOpportunities[idx].client = e.target.value;
                                  setSemblanceOpportunities(updatedOpportunities);
                                }}
                              />
                            ) : (
                              opp.client
                            )}
                          </td>
                          <td className="py-2 px-4 border-b">
                            {isEditing ? (
                              <select 
                                className="neu-input px-2 py-1 w-full"
                                value={opp.status}
                                onChange={(e) => {
                                  const updatedOpportunities = [...semblanceOpportunities];
                                  updatedOpportunities[idx].status = e.target.value;
                                  setSemblanceOpportunities(updatedOpportunities);
                                }}
                              >
                                {['Prospect', 'Pitch', 'In Progress', 'Confirmed'].map(status => (
                                  <option key={status} value={status}>{status}</option>
                                ))}
                              </select>
                            ) : (
                              <span className="status-badge text-xs" style={{
                                backgroundColor: STATUS_COLORS[opp.status],
                                color: 'white'
                              }}>
                                {opp.status}
                              </span>
                            )}
                          </td>
                          <td className="py-2 px-4 border-b text-right">
                            {isEditing ? (
                              <div className="flex items-center justify-end">
                                <span className="mr-1 text-gray-600">£</span>
                                <input 
                                  type="number" 
                                  className="neu-input px-2 py-1 w-24 text-right" 
                                  value={opp.value}
                                  onChange={(e) => {
                                    const updatedOpportunities = [...semblanceOpportunities];
                                    updatedOpportunities[idx].value = Number(e.target.value);
                                    setSemblanceOpportunities(updatedOpportunities);
                                  }}
                                />
                              </div>
                            ) : (
                              `£${(opp.value/1000).toFixed(0)}k`
                            )}
                          </td>
                          <td className="py-2 px-4 border-b text-sm">
                            {isEditing ? (
                              <input 
                                type="text" 
                                className="neu-input px-2 py-1 w-full" 
                                value={opp.notes || ''}
                                onChange={(e) => {
                                  const updatedOpportunities = [...semblanceOpportunities];
                                  updatedOpportunities[idx].notes = e.target.value;
                                  setSemblanceOpportunities(updatedOpportunities);
                                }}
                              />
                            ) : (
                              opp.notes
                            )}
                          </td>
                        </tr>
                      ))}
                      {isEditing && (
                        <tr>
                          <td colSpan={5} className="py-2 px-4 border-b">
                            <button 
                              className="w-full py-2 neu-btn text-gray-800 text-center"
                              onClick={() => {
                                setSemblanceOpportunities([...semblanceOpportunities, {
                                  client: '',
                                  status: 'Prospect',
                                  value: 20000,
                                  notes: ''
                                }]);
                              }}
                            >
                              + Add New Opportunity
                            </button>
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div className="neu-card p-5">
                  <h3 className="text-lg font-semibold mb-4">Semblance Opportunity Status</h3>
                  <div className="h-64">
                    <ResponsiveContainer width="100%" height="100%">
                      <PieChart>
                        <Pie
                          data={semblanceStatusData}
                          cx="50%"
                          cy="50%"
                          labelLine={false}
                          outerRadius={80}
                          fill="#8884d8"
                          dataKey="value"
                          label={({name, value}) => `${name}: £${(value/1000).toFixed(0)}k`}
                          labelStyle={{ fontSize: '6px', fill: '#333' }}
                        >
                          {semblanceStatusData.map((entry, index) => (
                            <Cell key={`cell-${index}`} fill={STATUS_COLORS[entry.name]} />
                          ))}
                        </Pie>
                        <Tooltip formatter={(value) => `£${(value/1000).toFixed(0)}k`} />
                        <Legend />
                      </PieChart>
                    </ResponsiveContainer>
                  </div>
                </div>
                
                <div className="neu-card p-5">
                  <h3 className="text-lg font-semibold mb-4">Revenue Impact of Semblance Conversions</h3>
                  <div className="space-y-4">
                    <div>
                      <div className="flex justify-between text-sm mb-1">
                        <span>Current confirmed</span>
                        <span className="font-medium">£{(confirmedSemblanceRevenue/1000).toFixed(0)}k</span>
                      </div>
                      <div className="w-full bg-gray-200 rounded-full h-4">
                        <div 
                          className="bg-green-500 h-4 rounded-full" 
                          style={{ width: `${(confirmedSemblanceRevenue/semblanceRevenue)*100}%` }}
                        ></div>
                      </div>
                    </div>
                    
                    <div>
                      <div className="flex justify-between text-sm mb-1">
                        <span>If 25% convert</span>
                        <span className="font-medium">£{((semblanceRevenue * 0.25)/1000).toFixed(0)}k</span>
                      </div>
                      <div className="w-full bg-gray-200 rounded-full h-4">
                        <div 
                          className="bg-blue-500 h-4 rounded-full" 
                          style={{ width: '25%' }}
                        ></div>
                      </div>
                    </div>
                    
                    <div>
                      <div className="flex justify-between text-sm mb-1">
                        <span>If 50% convert</span>
                        <span className="font-medium">£{((semblanceRevenue * 0.5)/1000).toFixed(0)}k</span>
                      </div>
                      <div className="w-full bg-gray-200 rounded-full h-4">
                        <div 
                          className="bg-purple-500 h-4 rounded-full" 
                          style={{ width: '50%' }}
                        ></div>
                      </div>
                    </div>
                    
                    <div>
                      <div className="flex justify-between text-sm mb-1">
                        <span>Total opportunity</span>
                        <span className="font-medium">£{(semblanceRevenue/1000).toFixed(0)}k</span>
                      </div>
                      <div className="w-full bg-gray-200 rounded-full h-4">
                        <div 
                          className="bg-amber-500 h-4 rounded-full" 
                          style={{ width: '100%' }}
                        ></div>
                      </div>
                    </div>
                  </div>
                  
                  <div className="mt-4 p-3 neu-card-inner neu-accent1">
                    <p className="text-sm">
                      <strong>Key insight:</strong> Converting just 3-4 Semblance opportunities would justify additional headcount
                    </p>
                  </div>
                </div>
              </div>
            </div>
          )}
          
          {activeView === 'pipeline' && (
            <div className="space-y-6">
              <div className="neu-card p-5">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-semibold">Pipeline & Biz Dev</h2>
                  {!isEditing && (
                    <button 
                      className="neu-btn neu-secondary px-4 py-2 text-white rounded hover:shadow-lg"
                      onClick={() => {
                        // Save original data for both sections
                        setOriginalData(JSON.parse(JSON.stringify({
                          pipelineProjects: pipelineProjects,
                          internalActivities: internalActivities
                        })));
                        setIsEditing(true);
                      }}
                    >
                      Edit
                    </button>
                  )}
                  {isEditing && (
                    <div className="flex space-x-2 items-center">
                      {hasUnsavedChanges && (
                        <span className="text-amber-600 text-sm mr-2">
                          <span className="inline-block w-2 h-2 bg-amber-500 rounded-full mr-1"></span>
                          Unsaved changes
                        </span>
                      )}
                      <button 
                        className="neu-btn neu-accent3 px-4 py-2"
                        onClick={() => {
                          setIsEditing(false);
                          setOriginalData(null);
                          showNotification('Changes saved to localStorage');
                        }}
                      >
                        Save All Changes
                      </button>
                      <button 
                        className="neu-btn neu-primary px-4 py-2 text-white"
                        onClick={() => {
                        // Restore original data for both sections
                        setPipelineProjects(originalData.pipelineProjects);
                        setInternalActivities(originalData.internalActivities);
                        setIsEditing(false);
                        setOriginalData(null);
                      }}
                    >
                      Cancel
                    </button>
                  </div>
                )}
                </div>
              </div>
              
              {/* PIPELINE OPPORTUNITIES SECTION */}
              <div className="neu-card p-5">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-semibold">Major Pipeline Opportunities</h2>
                </div>
                <div className="overflow-x-auto">
                  <table className="min-w-full neu-table">
                    <thead>
                      <tr>
                        {isEditing && <th className="py-2 px-4 border-b text-left">Actions</th>}
                        <th className="py-2 px-4 border-b text-left">Project</th>
                        <th className="py-2 px-4 border-b text-left">Status</th>
                        <th className="py-2 px-4 border-b text-right">Value</th>
                        <th className="py-2 px-4 border-b text-left">Notes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {pipelineProjects.map((project, idx) => (
                        <tr key={idx}>
                          {isEditing && (
                            <td className="py-2 px-4 border-b">
                              <button 
                                className="text-red-500 hover:text-red-700"
                                onClick={() => {
                                  const updatedProjects = [...pipelineProjects];
                                  updatedProjects.splice(idx, 1);
                                  setPipelineProjects(updatedProjects);
                                }}
                              >
                                Delete
                              </button>
                            </td>
                          )}
                          <td className="py-2 px-4 border-b font-medium">
                            {isEditing ? (
                              <input 
                                type="text" 
                                className="neu-input px-2 py-1 w-full" 
                                value={project.name}
                                onChange={(e) => {
                                  const updatedProjects = [...pipelineProjects];
                                  updatedProjects[idx].name = e.target.value;
                                  setPipelineProjects(updatedProjects);
                                }}
                              />
                            ) : (
                              project.name
                            )}
                          </td>
                          <td className="py-2 px-4 border-b">
                            {isEditing ? (
                              <select 
                                className="neu-input px-2 py-1 w-full"
                                value={project.status}
                                onChange={(e) => {
                                  const updatedProjects = [...pipelineProjects];
                                  updatedProjects[idx].status = e.target.value;
                                  setPipelineProjects(updatedProjects);
                                }}
                              >
                                {['Pipeline', 'Active Account'].map(status => (
                                  <option key={status} value={status}>{status}</option>
                                ))}
                              </select>
                            ) : (
                              <span className="status-badge text-xs" style={{
                                backgroundColor: STATUS_COLORS[project.status],
                                color: 'white'
                              }}>
                                {project.status}
                              </span>
                            )}
                          </td>
                          <td className="py-2 px-4 border-b text-right">
                            {isEditing ? (
                              <div className="flex items-center justify-end">
                                <span className="mr-1 text-gray-600">£</span>
                                <input 
                                  type="number" 
                                  className="neu-input px-2 py-1 w-24 text-right" 
                                  value={project.value}
                                  onChange={(e) => {
                                    const updatedProjects = [...pipelineProjects];
                                    updatedProjects[idx].value = Number(e.target.value);
                                    setPipelineProjects(updatedProjects);
                                  }}
                                />
                              </div>
                            ) : (
                              `£${project.value >= 1000000 ? (project.value/1000000).toFixed(1) + 'm' : (project.value/1000).toFixed(0) + 'k'}`
                            )}
                          </td>
                          <td className="py-2 px-4 border-b">
                            {isEditing ? (
                              <input 
                                type="text" 
                                className="neu-input px-2 py-1 w-full" 
                                value={project.notes || ''}
                                onChange={(e) => {
                                  const updatedProjects = [...pipelineProjects];
                                  updatedProjects[idx].notes = e.target.value;
                                  setPipelineProjects(updatedProjects);
                                }}
                              />
                            ) : (
                              project.notes
                            )}
                          </td>
                        </tr>
                      ))}
                      {isEditing && (
                        <tr>
                          <td colSpan={5} className="py-2 px-4 border-b">
                            <button 
                              className="w-full py-2 neu-btn text-gray-800 text-center"
                              onClick={() => {
                                setPipelineProjects([...pipelineProjects, {
                                  name: '',
                                  status: 'Pipeline',
                                  value: 100000,
                                  notes: ''
                                }]);
                              }}
                            >
                              + Add New Pipeline Project
                            </button>
                          </td>
                        </tr>
                      )}
                    </tbody>
                    <tfoot className="bg-gray-50">
                      <tr>
                        <td className="py-2 px-4 border-b font-medium" colSpan="2">Total pipeline</td>
                        <td className="py-2 px-4 border-b text-right font-medium">£{(pipelineProjects.reduce((sum, project) => sum + project.value, 0) >= 1000000 ? (pipelineProjects.reduce((sum, project) => sum + project.value, 0)/1000000).toFixed(1) + 'm' : (pipelineProjects.reduce((sum, project) => sum + project.value, 0)/1000).toFixed(0) + 'k')}</td>
                        <td></td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
              </div>
              
              {/* BUSINESS DEV ACTIVITIES SECTION */}
              <div className="neu-card p-5">
                <div className="flex justify-between items-center mb-4">
                  <h2 className="text-xl font-semibold">Business Development Activities</h2>
                </div>
                <div className="overflow-x-auto">
                  <table className="min-w-full neu-table">
                    <thead>
                      <tr>
                        {isEditing && <th className="py-2 px-4 border-b text-left">Actions</th>}
                        <th className="py-2 px-4 border-b text-left">Activity</th>
                        <th className="py-2 px-4 border-b text-left">Type</th>
                        <th className="py-2 px-4 border-b text-left">Timeframe</th>
                        <th className="py-2 px-4 border-b text-left">Time impact</th>
                        <th className="py-2 px-4 border-b text-left">Notes</th>
                      </tr>
                    </thead>
                    <tbody>
                      {internalActivities.map((activity, idx) => (
                        <tr key={idx}>
                          {isEditing && (
                            <td className="py-2 px-4 border-b">
                              <button 
                                className="text-red-500 hover:text-red-700"
                                onClick={() => {
                                  const updatedActivities = [...internalActivities];
                                  updatedActivities.splice(idx, 1);
                                  setInternalActivities(updatedActivities);
                                }}
                              >
                                Delete
                              </button>
                            </td>
                          )}
                          <td className="py-2 px-4 border-b font-medium">
                            {isEditing ? (
                              <input 
                                type="text" 
                                className="neu-input px-2 py-1 w-full" 
                                value={activity.name}
                                onChange={(e) => {
                                  const updatedActivities = [...internalActivities];
                                  updatedActivities[idx].name = e.target.value;
                                  setInternalActivities(updatedActivities);
                                }}
                              />
                            ) : (
                              activity.name
                            )}
                          </td>
                          <td className="py-2 px-4 border-b">
                            {isEditing ? (
                              <select 
                                className="neu-input px-2 py-1 w-full" 
                                value={activity.type}
                                onChange={(e) => {
                                  const updatedActivities = [...internalActivities];
                                  updatedActivities[idx].type = e.target.value;
                                  setInternalActivities(updatedActivities);
                                }}
                              >
                                {['Keynote', 'Presentation', 'Documentation', 'Admin'].map(type => (
                                  <option key={type} value={type}>{type}</option>
                                ))}
                              </select>
                            ) : (
                              activity.type
                            )}
                          </td>
                          <td className="py-2 px-4 border-b">
                            {isEditing ? (
                              <input 
                                type="text" 
                                className="neu-input px-2 py-1 w-full" 
                                value={activity.timeframe}
                                onChange={(e) => {
                                  const updatedActivities = [...internalActivities];
                                  updatedActivities[idx].timeframe = e.target.value;
                                  setInternalActivities(updatedActivities);
                                }}
                              />
                            ) : (
                              activity.timeframe
                            )}
                          </td>
                          <td className="py-2 px-4 border-b">
                            {isEditing ? (
                              <select 
                                className="neu-input px-2 py-1 w-full" 
                                value={activity.timeImpact}
                                onChange={(e) => {
                                  const updatedActivities = [...internalActivities];
                                  updatedActivities[idx].timeImpact = e.target.value;
                                  setInternalActivities(updatedActivities);
                                }}
                              >
                                {['High', 'Medium', 'Low'].map(impact => (
                                  <option key={impact} value={impact}>{impact}</option>
                                ))}
                              </select>
                            ) : (
                              <span className="status-badge text-xs" style={{
                                backgroundColor: activity.timeImpact === 'High' ? '#ff5252' : 
                                                activity.timeImpact === 'Medium' ? '#ffcc01' : 
                                                '#32ff7e',
                                color: activity.timeImpact === 'Medium' ? 'black' : 'white'
                              }}>
                                {activity.timeImpact}
                              </span>
                            )}
                          </td>
                          <td className="py-2 px-4 border-b text-sm">
                            {isEditing ? (
                              <input 
                                type="text" 
                                className="neu-input px-2 py-1 w-full" 
                                value={activity.notes || ''}
                                onChange={(e) => {
                                  const updatedActivities = [...internalActivities];
                                  updatedActivities[idx].notes = e.target.value;
                                  setInternalActivities(updatedActivities);
                                }}
                              />
                            ) : (
                              activity.notes
                            )}
                          </td>
                        </tr>
                      ))}
                      {isEditing && (
                        <tr>
                          <td colSpan={6} className="py-2 px-4 border-b">
                            <button 
                              className="w-full py-2 neu-btn text-gray-800 text-center"
                              onClick={() => {
                                setInternalActivities([...internalActivities, {
                                  name: '',
                                  type: 'Keynote',
                                  timeframe: '',
                                  timeImpact: 'Medium',
                                  notes: ''
                                }]);
                              }}
                            >
                              + Add New Activity
                            </button>
                          </td>
                        </tr>
                      )}
                    </tbody>
                  </table>
                </div>
                
                <div className="mt-4 p-3 neu-card-inner neu-primary">
                  <p className="text-sm text-black">
                    <strong>Resource impact:</strong> Business development activities require approximately {totalBusinessDevDays.toFixed(1)} days per quarter, equivalent to {(totalBusinessDevDays/12).toFixed(1)} days per week of Alec's time
                  </p>
                </div>
              </div>
              
              <div className="neu-card p-5">
                <div className="mb-4">
                  <h2 className="text-lg font-semibold">Key Insights for Resourcing</h2>
                </div>
                <div className="space-y-3">
                  {resourcingInsights.map((insight, idx) => (
                    <div key={insight.id} className={`p-3 neu-card-inner ${
                        insight.type === 'red' ? 'neu-primary' :
                        insight.type === 'amber' ? 'neu-accent2' :
                        insight.type === 'green' ? 'neu-accent3' :
                        insight.type === 'purple' ? 'neu-accent4' :
                        'neu-accent1'
                      }`}>
                      {isEditing ? (
                        <div className="space-y-2">
                          <div className="flex justify-between">
                            <div className="flex items-center space-x-2">
                              <span className="text-sm text-gray-500">Type:</span>
                              <select 
                                className="neu-input px-2 py-1"
                                value={insight.type}
                                onChange={(e) => {
                                  const updatedInsights = [...resourcingInsights];
                                  updatedInsights[idx].type = e.target.value;
                                  setResourcingInsights(updatedInsights);
                                }}
                              >
                                {['amber', 'blue', 'green', 'red', 'purple'].map(type => (
                                  <option key={type} value={type}>{type}</option>
                                ))}
                              </select>
                            </div>
                            <button 
                              className="text-red-500 hover:text-red-700"
                              onClick={() => {
                                const updatedInsights = [...resourcingInsights];
                                updatedInsights.splice(idx, 1);
                                setResourcingInsights(updatedInsights);
                              }}
                            >
                              Delete
                            </button>
                          </div>
                          <div>
                            <input 
                              type="text" 
                              className="neu-input px-2 py-1 w-full mb-2" 
                              placeholder="Title"
                              value={insight.title}
                              onChange={(e) => {
                                const updatedInsights = [...resourcingInsights];
                                updatedInsights[idx].title = e.target.value;
                                setResourcingInsights(updatedInsights);
                              }}
                            />
                            <textarea 
                              className="neu-input px-2 py-1 w-full" 
                              rows="3"
                              placeholder="Content"
                              value={insight.content}
                              onChange={(e) => {
                                const updatedInsights = [...resourcingInsights];
                                updatedInsights[idx].content = e.target.value;
                                setResourcingInsights(updatedInsights);
                              }}
                            />
                          </div>
                        </div>
                      ) : (
                        <p><strong>{insight.title}:</strong> {insight.content}</p>
                      )}
                    </div>
                  ))}
                  
                  {isEditing && (
                    <button 
                      className="w-full py-2 neu-btn text-gray-800 text-center"
                      onClick={() => {
                        const newId = Math.max(...resourcingInsights.map(insight => insight.id), 0) + 1;
                        setResourcingInsights([...resourcingInsights, {
                          id: newId,
                          type: 'blue',
                          title: 'New Insight',
                          content: 'Add your insight here'
                        }]);
                      }}
                    >
                      + Add New Insight
                    </button>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    // Render the application
    ReactDOM.render(<AgencyDashboard />, document.getElementById('root'));
  </script>
</body>
</html>
